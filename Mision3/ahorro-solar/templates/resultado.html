{% extends "base.html" %}

{% block title %}Resultado - SolarTech{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="bg-gradient-to-br from-teal-100 via-cyan-100 to-blue-100 dark:from-gray-800 dark:via-gray-900 dark:to-black min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 transition-colors duration-300">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-5xl text-center transition-all duration-300 hover:shadow-2xl border border-gray-100 dark:border-gray-700" data-aos="fade-up">
      <h2 class="text-3xl font-bold text-teal-800 dark:text-teal-400 mb-6">
          Resultado del Ahorro
      </h2>
      
      <!-- Single Result Layout (Original) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <!-- Prediction Box -->
          <div class="bg-teal-100 dark:bg-teal-900/30 p-6 rounded-xl border border-teal-100 dark:border-teal-800">
              <p class="text-lg text-gray-600 dark:text-gray-200 mb-2">
                Ahorro estimado mensual:
              </p>
              <div class="text-3xl font-extrabold text-teal-600 dark:text-teal-300 mb-2">
                {{prediccion}}
              </div>  
              <p class="text-sm text-gray-500 dark:text-gray-300">
                Este c谩lculo es una estimaci贸n basada en los datos proporcionados.
              </p>
          </div>

          <!-- Impact Box -->
          <div class="bg-green-100 dark:bg-green-900/30 p-6 rounded-xl border border-green-100 dark:border-green-800 flex flex-col justify-center items-center">
              <h3 class="font-bold text-green-800 dark:text-green-300 mb-4">Impacto Ambiental Mensual</h3>
              <div class="flex space-x-4">
                  <div class="text-center" title="rboles equivalentes plantados">
                      <div class="text-3xl"></div>
                      <div class="text-sm font-bold text-gray-700 dark:text-gray-100 mt-1">~{{ arboles }} rboles</div>
                  </div>
                  <div class="text-center" title="CO2 evitado">
                      <div class="text-3xl"></div>
                      <div class="text-sm font-bold text-gray-700 dark:text-gray-100 mt-1">-{{ co2 }}kg CO2</div>
                  </div>
              </div>
          </div>
          
          <!-- ROI Box -->
          <div class="md:col-span-2 bg-blue-100 dark:bg-blue-900/30 p-6 rounded-xl border border-blue-100 dark:border-blue-800">
              <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2">Retorno de Inversi贸n (ROI)</h3>
              <p class="text-gray-600 dark:text-gray-200">
                  Recuperar谩s tu inversi贸n en aproximadamente <span class="font-bold text-blue-600 dark:text-blue-200">{{ anios_recuperacion }} a帽os</span> ({{ meses_recuperacion }} meses).
              </p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-4">
                  <div class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  *Estimaci贸n basada en el costo de instalaci贸n y el ahorro mensual proyectado.
              </p>
          </div>
      </div>

      <!-- Chart -->
      <div class="mb-8 h-64">
          <canvas id="savingsChart"></canvas>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="{{url_for('formulario')}}" class="inline-block w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-[1.02] shadow-md">
            Calcular nuevamente
          </a>
      </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('savingsChart').getContext('2d');
    
    // Helper to parse currency string to number
    const parseCurrency = (str) => parseFloat(str.replace(/[^0-9]/g, ''));

    // Data for Scenario
    const valA = parseCurrency("{{ prediccion }}");
    const dataA = [valA, valA * 12, valA * 12 * 5, valA * 12 * 10];
    
    let savingsChart;

    function initChart() {
        if (savingsChart) {
            savingsChart.destroy();
        }

        const isDark = document.documentElement.classList.contains('dark');
        
        const datasets = [{
            label: 'Ahorro Estimado (COP)',
            data: dataA,
            backgroundColor: isDark ? 'rgba(94, 234, 212, 0.8)' : 'rgba(13, 148, 136, 0.7)', // Teal 300 (Dark) vs Teal 600 (Light)
            borderColor: isDark ? 'rgb(94, 234, 212)' : 'rgb(13, 148, 136)',
            borderWidth: 2,
            hoverBackgroundColor: isDark ? 'rgba(94, 234, 212, 1)' : 'rgba(13, 148, 136, 0.9)'
        }];

        savingsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1 Mes', '1 A帽o', '5 A帽os', '10 A帽os'],
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Hide legend for single dataset
                    },
                    title: {
                        display: true,
                        text: 'Proyecci贸n de Ahorro a Largo Plazo',
                        color: isDark ? '#ffffff' : '#374151',
                        font: { size: 16 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: isDark ? '#ffffff' : '#4b5563',
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        },
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        ticks: { color: isDark ? '#ffffff' : '#4b5563' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Initialize chart
    initChart();

    // Watch for dark mode changes
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                initChart();
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });
</script>
{% endblock %}
